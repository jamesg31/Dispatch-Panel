import { app, BrowserWindow, shell } from "electron";
import electronLocalShortcut from "electron-localshortcut";
import installExtension, {
  REACT_DEVELOPER_TOOLS,
} from "electron-extension-installer";
import { ipcMain } from "electron";
import {
  ConfigSchemaType,
  configStore,
  LocationsSchemaType,
  locationsStore,
  postalStore,
  SettingsSchemaType,
  settingsStore,
  StateSchemaType,
  stateStore,
  CONFIG_VERSION,
  LOCATIONS_VERSION,
  SETTINGS_VERSION,
  STATE_VERSION,
  POSTALS_VERSION,
  PostalsSchemaType,
} from "./config";
import ElectronStore from "electron-store";
import { updateElectronApp } from "update-electron-app";
import pjson from "../package.json";

// This allows TypeScript to pick up the magic constants that's auto-generated by Forge's Webpack
// plugin that tells the Electron app where to look for the Webpack-bundled app code (depending on
// whether you're running in development or production).
declare const MAIN_WINDOW_WEBPACK_ENTRY: string;
declare const MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY: string;
declare const SETTINGS_WINDOW_WEBPACK_ENTRY: string;
declare const SETTINGS_WINDOW_PRELOAD_WEBPACK_ENTRY: string;
declare const UNITS_WINDOW_WEBPACK_ENTRY: string;
declare const UNITS_WINDOW_PRELOAD_WEBPACK_ENTRY: string;
declare const WELCOME_WINDOW_WEBPACK_ENTRY: string;
declare const WELCOME_WINDOW_PRELOAD_WEBPACK_ENTRY: string;

let mainWindow: BrowserWindow | null = null;
let settingsWindow: BrowserWindow | null = null;
let unitsWindow: BrowserWindow | null = null;
let welcomeWindow: BrowserWindow | null = null;

// Handle creating/removing shortcuts on Windows when installing/uninstalling.
if (require("electron-squirrel-startup")) {
  app.quit();
}

// @ts-ignore
if (configStore.get("version") !== CONFIG_VERSION) {
  console.warn(
    "Config out of date, resetting to defaults. (version " +
      CONFIG_VERSION +
      ")"
  );
  // @ts-ignore
  configStore.clear();
}
// @ts-ignore
if (locationsStore.get("version") !== LOCATIONS_VERSION) {
  console.warn(
    "Locations out of date, resetting to defaults. (version " +
      LOCATIONS_VERSION +
      ")"
  );
  // @ts-ignore
  locationsStore.clear();
}
// @ts-ignore
if (postalStore.get("version") !== POSTALS_VERSION) {
  console.warn(
    "Postals out of date, resetting to defaults. (version " +
      POSTALS_VERSION +
      ")"
  );
  // @ts-ignore
  postalStore.clear();
}
// @ts-ignore
if (settingsStore.get("version") !== SETTINGS_VERSION) {
  console.warn(
    "Settings out of date, resetting to defaults. (version " +
      SETTINGS_VERSION +
      ")"
  );
  // @ts-ignore
  settingsStore.clear();
}
// @ts-ignore
if (stateStore.get("version") !== STATE_VERSION) {
  console.warn(
    "State out of date, resetting to defaults. (version " + STATE_VERSION + ")"
  );
  // @ts-ignore
  stateStore.clear();
}

// if auto-updates are enabled, enable them
// @ts-ignore
const settings = settingsStore.get("config");
if (settings.autoUpdate) {
  updateElectronApp();
}

const createMainWindow = (): BrowserWindow => {
  // Create the browser window.
  const mainWindow = new BrowserWindow({
    height: 600,
    width: 800,
    webPreferences: {
      preload: MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY,
    },
  });

  // Remove the default menu bar
  mainWindow.removeMenu();

  // and load the index.html of the app.
  mainWindow.loadURL(MAIN_WINDOW_WEBPACK_ENTRY);

  if (process.env.NODE_ENV === "development") {
    // Open the DevTools.
    mainWindow.webContents.openDevTools();
  }

  return mainWindow;
};

const createSettingsWindow = (parent: BrowserWindow): BrowserWindow => {
  let height, width;
  // if operating system, change window size
  if (process.platform !== "darwin") {
    height = 454;
    width = 350;
  } else {
    height = 443;
    width = 300;
  }
  // Create the browser window.
  const settingsWindow = new BrowserWindow({
    height: height,
    width: width,
    resizable: false,
    webPreferences: {
      preload: SETTINGS_WINDOW_PRELOAD_WEBPACK_ENTRY,
    },
    parent: parent,
  });

  // remove default menu bar
  settingsWindow.removeMenu();

  // and load the index.html of the app.
  settingsWindow.loadURL(SETTINGS_WINDOW_WEBPACK_ENTRY);

  return settingsWindow;
};

const createUnitsWindow = (parent: BrowserWindow): BrowserWindow => {
  // Create the browser window.
  const unitsWindow = new BrowserWindow({
    height: 500,
    width: 500,
    webPreferences: {
      preload: UNITS_WINDOW_PRELOAD_WEBPACK_ENTRY,
    },
    parent: parent,
  });

  // remove default menu bar
  unitsWindow.removeMenu();

  // and load the index.html of the app.
  unitsWindow.loadURL(UNITS_WINDOW_WEBPACK_ENTRY);

  return unitsWindow;
};

const createWelcomeWindow = (parent: BrowserWindow): BrowserWindow => {
  // Create the browser window.
  const welcomeWindow = new BrowserWindow({
    height: 500,
    width: 700,
    webPreferences: {
      preload: WELCOME_WINDOW_PRELOAD_WEBPACK_ENTRY,
    },
    parent: parent,
  });

  // remove default menu bar
  welcomeWindow.removeMenu();

  // and load the index.html of the app.
  welcomeWindow.loadURL(WELCOME_WINDOW_WEBPACK_ENTRY);

  return welcomeWindow;
};

// This method will be called when Electron has finished
// initialization and is ready to create browser windows.
// Some APIs can only be used after this event occurs.
app.on("ready", async () => {
  if (process.env.NODE_ENV === "development") {
    await installExtension(REACT_DEVELOPER_TOOLS, {
      loadExtensionOptions: {
        allowFileAccess: true,
      },
    });
  }

  mainWindow = createMainWindow();

  // @ts-ignore
  if (settingsStore.get("config.stayOnTop") === true) {
    mainWindow.setAlwaysOnTop(true);
  }

  electronLocalShortcut.register("CmdOrCtrl+S", () => {
    if (settingsWindow) {
      settingsWindow.focus();
    } else {
      settingsWindow = createSettingsWindow(mainWindow);
      settingsWindow.addListener("close", () => {
        settingsWindow = null;
      });
    }
  });

  electronLocalShortcut.register("CmdOrCtrl+U", () => {
    if (unitsWindow) {
      unitsWindow.focus();
    } else {
      unitsWindow = createUnitsWindow(mainWindow);
      unitsWindow.addListener("close", () => {
        unitsWindow = null;
      });
    }
  });

  if (
    // @ts-ignore
    stateStore.get("config.lastWelcomeVersion") !== pjson.version ||
    process.env.NODE_ENV === "development"
  ) {
    welcomeWindow = createWelcomeWindow(mainWindow);
    welcomeWindow.addListener("close", () => {
      welcomeWindow = null;
      // @ts-ignore
      stateStore.set("config.lastWelcomeVersion", pjson.version);
    });
    welcomeWindow.webContents.setWindowOpenHandler(({ url }) => {
      shell.openExternal(url);
      return { action: "deny" };
    });
  }
});

// Quit when all windows are closed, except on macOS. There, it's common
// for applications and their menu bar to stay active until the user quits
// explicitly with Cmd + Q.
app.on("window-all-closed", () => {
  if (process.platform !== "darwin") {
    app.quit();
  }
});

app.on("activate", () => {
  // On OS X it's common to re-create a window in the app when the
  // dock icon is clicked and there are no other windows open.
  if (BrowserWindow.getAllWindows().length === 0) {
    createMainWindow();
  }
});

const getStore = (
  store: string
): ElectronStore<
  | ConfigSchemaType
  | LocationsSchemaType
  | PostalsSchemaType
  | SettingsSchemaType
  | StateSchemaType
> => {
  if (store === "config") {
    return configStore;
  }
  if (store === "locations") {
    return locationsStore;
  }
  if (store === "postals") {
    return postalStore;
  }
  if (store === "settings") {
    return settingsStore;
  }
  if (store === "state") {
    return stateStore;
  }
};

ipcMain.handle("electron-store-get", async (_, store, val) => {
  // @ts-ignore
  return getStore(store).get(val);
});
ipcMain.handle("electron-store-set", async (_, store, key, val) => {
  // @ts-ignore
  return getStore(store).set(key, val);
});
ipcMain.handle("reload", () => {
  mainWindow?.reload();
  settingsWindow?.reload();
  welcomeWindow?.reload();
});
ipcMain.handle("open-config-dir", () => {
  shell.openPath(app.getPath("userData"));
});
